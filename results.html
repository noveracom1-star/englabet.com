<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Transaction History — Dewdrop</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    :root{
      --ocean-900: #003f63;
      --ocean-700: #0072a8;
      --ocean-500: #00a0ff;
      --ocean-300: #7fd1ff;
      --white: #ffffff;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.08);
      --card-radius: 12px;
      --shadow-lg: 0 10px 30px rgba(3,10,34,0.25);
      --shadow-md: 0 6px 18px rgba(3,10,34,0.12);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      padding:0;
      background: linear-gradient(180deg, #eaf8ff 0%, #f7fbff 100%);
      color: #0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x: hidden;
    }

    /* Page container - MOBILE FIRST */
    .page {
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      min-height: 100vh;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .brand {
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg,var(--ocean-700),var(--ocean-500));
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow-md);
      color:var(--white);
      font-weight:800;
      font-size: 16px;
      letter-spacing:0.6px;
      flex-shrink: 0;
    }

    .brand-text {
      min-width: 0;
    }

    h1 {
      margin:0;
      font-size: 18px;
      font-weight:700;
      color:var(--ocean-900);
      line-height: 1.2;
    }

    .sub {
      color:var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    /* Controls */
    .controls {
      display:flex;
      gap: 8px;
      align-items:center;
      width: 100%;
      margin-top: 12px;
      order: 3;
    }

    .search {
      background:var(--white);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: var(--shadow-md);
      display:flex;
      gap: 8px;
      align-items:center;
      flex: 1;
      min-width: 0;
    }

    .search input{
      border:0;
      outline:none;
      font-size: 14px;
      width: 100%;
      background: transparent;
    }

    .filter-btn{
      background:var(--white);
      border:1px solid rgba(0,0,0,0.06);
      padding: 10px 12px;
      border-radius: 10px;
      font-weight:600;
      cursor:pointer;
      box-shadow:var(--shadow-md);
      font-size: 13px;
      white-space: nowrap;
    }

    .filter-btn.active {
      background: linear-gradient(90deg,var(--ocean-700), var(--ocean-500));
      color: var(--white);
    }

    /* List container */
    .list {
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 16px;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--ocean-300);
      border-top: 2px solid var(--ocean-700);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Receipt row (horizontal) */
    .receipt {
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      border-radius: var(--card-radius);
      padding: 14px;
      display:flex;
      align-items:center;
      gap: 12px;
      cursor:pointer;
      border-left: 4px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .receipt.win {
      border-left-color: #0a8f3c;
    }

    .receipt.lose {
      border-left-color: #d63d3d;
    }

    .receipt:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .receipt .left {
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }

    .game-badge {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg,var(--ocean-700),var(--ocean-500));
      color:var(--white);
      font-weight:800;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,112,168,0.25);
      flex-shrink:0;
    }

    .meta {
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
      flex: 1;
    }

    .meta .title {
      font-weight:700;
      color:var(--ocean-900);
      letter-spacing:0.4px;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta .small {
      font-size: 12px;
      color:var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .middle {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }

    .tag {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(0,160,255,0.07), rgba(0,112,168,0.04));
      color:var(--ocean-700);
      font-weight:600;
      border:1px solid rgba(0,112,168,0.06);
      white-space: nowrap;
    }

    .amount {
      font-weight:800;
      font-size: 16px;
      white-space: nowrap;
    }

    .amount.plus{
      color: #0a8f3c;
    }

    .amount.minus{
      color: #d63d3d;
    }

    /* small note */
    .note {
      display:block;
      color:var(--muted);
      font-size: 11px;
      white-space: nowrap;
    }

    /* Modal (pop-out) */
    .overlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(3,10,34,0.45);
      backdrop-filter: blur(4px);
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease;
      z-index:60;
      padding: 16px;
      box-sizing: border-box;
    }

    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .modal {
      width: 100%;
      max-width: 500px;
      max-height:90vh;
      overflow:auto;
      border-radius:16px;
      background: linear-gradient(180deg, var(--white), #fbfeff);
      box-shadow: 0 20px 50px rgba(3,10,34,0.45);
      transform: translateY(10px) scale(.99);
      transition: transform .28s cubic-bezier(.2,.9,.3,1);
      position:relative;
      border:1px solid rgba(0,0,0,0.04);
    }

    .overlay.open .modal{
      transform: translateY(0) scale(1);
    }

    .modal-header {
      background: linear-gradient(135deg, var(--ocean-700), var(--ocean-500));
      padding: 20px 20px 16px 20px;
      border-top-left-radius:16px;
      border-top-right-radius:16px;
      color:var(--white);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .modal-header .center-title{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-direction:column;
      text-align:center;
    }

    .modal-header .game-big {
      font-size: 18px;
      font-weight:800;
      letter-spacing:0.8px;
    }

    .modal-header .sub-title {
      font-size: 12px;
      opacity:0.95;
      font-weight:600;
    }

    .close-btn {
      position:absolute;
      right: 16px;
      top: 16px;
      background:rgba(255,255,255,0.12);
      border:none;
      padding: 8px;
      border-radius: 10px;
      color:var(--white);
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      display:flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
    }

    /* left: big receipt details */
    .receipt-card {
      background: linear-gradient(180deg, rgba(0,112,168,0.03), rgba(127,209,255,0.02));
      border-radius:12px;
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .receipt-card .top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .receipt-card .top .left {
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .receipt-card .top .left .badge {
      width: 56px;
      height: 56px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background: linear-gradient(135deg,var(--ocean-700),var(--ocean-500));
      color:var(--white);
      font-size: 16px;
      flex-shrink: 0;
    }

    .player-info {
      min-width: 0;
    }

    .player-name {
      font-weight:800;
      font-size: 14px;
      color: var(--ocean-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-date {
      color:var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .receipt-grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      color:var(--ocean-900);
    }

    .field {
      background:var(--white);
      border-radius: 10px;
      padding: 12px;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow: var(--shadow-md);
    }

    .field .label {
      font-size: 11px;
      color:var(--muted);
      font-weight:700;
    }

    .field .value {
      margin-top: 6px;
      font-weight:800;
      font-size: 14px;
      color:var(--ocean-900);
      word-break: break-all;
    }

    .receipt-card .notes {
      margin-top: 14px;
      font-size: 12px;
      color:var(--muted);
      line-height: 1.4;
    }

    /* right column: side details like OPAY receipt style listing */
    .side {
      border-radius:12px;
      padding: 14px;
      background:var(--white);
      border:1px solid rgba(0,0,0,0.04);
      box-shadow: var(--shadow-md);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .side .row {
      display:flex;
      justify-content:space-between;
      gap: 8px;
      align-items:center;
      padding: 8px 4px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .side .row:last-child {
      border-bottom: none;
    }

    .side .row .k {
      color:var(--muted);
      font-weight:700;
      font-size: 12px;
      flex-shrink: 0;
    }

    .side .row .v {
      font-weight:800;
      text-align:right;
      font-size: 13px;
      word-break: break-all;
      margin-left: 8px;
    }

    .side .cta {
      margin-top: 8px;
      display:flex;
      gap: 8px;
    }

    .btn {
      flex:1;
      border-radius: 10px;
      padding: 12px 14px;
      border:0;
      font-weight:800;
      cursor:pointer;
      font-size: 14px;
    }

    .btn.primary {
      background: linear-gradient(90deg,var(--ocean-700), var(--ocean-500));
      color:var(--white);
      box-shadow: 0 6px 20px rgba(0,112,168,0.2);
    }

    .btn.ghost {
      background:transparent;
      border:1px solid rgba(0,0,0,0.06);
      color:var(--ocean-900);
    }

    /* Words Modal */
    .words-modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 70;
      background: rgba(3,10,34,0.45);
      backdrop-filter: blur(4px);
      padding: 16px;
      box-sizing: border-box;
    }

    .words-modal.open {
      display: grid;
    }

    .words-container {
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
      border-radius: 16px;
      background: linear-gradient(180deg, var(--white), #fbfeff);
      box-shadow: 0 20px 50px rgba(3,10,34,0.45);
      position: relative;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .words-header {
      background: linear-gradient(135deg, var(--ocean-700), var(--ocean-500));
      padding: 20px 20px 16px 20px;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .words-header .center-title {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-direction: column;
      text-align: center;
    }

    .words-header .game-big {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.8px;
    }

    .words-header .sub-title {
      font-size: 12px;
      opacity: 0.95;
      font-weight: 600;
    }

    .words-close-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      background: rgba(255,255,255,0.12);
      border: none;
      padding: 8px;
      border-radius: 10px;
      color: var(--white);
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .words-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .words-section {
      background: var(--white);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .words-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ocean-900);
    }

    .word-bag-display {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .letter-chip {
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--ocean-700), var(--ocean-500));
      color: var(--white);
      font-weight: 900;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .words-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .word-badge {
      padding: 8px 12px;
      background: rgba(0,160,255,0.1);
      border: 1px solid rgba(0,160,255,0.2);
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
    }

    .word-badge.valid {
      background: rgba(10, 143, 60, 0.1);
      border-color: rgba(10, 143, 60, 0.3);
    }

    .word-badge.invalid {
      background: rgba(214, 61, 61, 0.1);
      border-color: rgba(214, 61, 61, 0.3);
    }

    /* Tablet and desktop */
    @media (min-width: 768px) {
      .page {
        max-width: 800px;
        padding: 24px;
      }

      header {
        flex-wrap: nowrap;
      }

      .controls {
        width: auto;
        margin-top: 0;
        order: 0;
      }

      .search {
        min-width: 200px;
      }

      .receipt-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .modal-body {
        flex-direction: row;
      }

      .receipt-card {
        flex: 1;
      }

      .side {
        width: 300px;
        flex-shrink: 0;
      }
    }

    /* Large desktop */
    @media (min-width: 1024px) {
      .page {
        max-width: 1100px;
      }
    }
  </style>
</head>
<body>

<div class="page">
  <header>
    <div class="brand">
      <div class="logo">DD</div>
      <div class="brand-text">
        <h1>Transaction History</h1>
        <div class="sub">Recent game results & receipts</div>
      </div>
    </div>

    <div class="controls">
      <div class="search" aria-hidden="false">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.6"><path d="M21 21l-4.35-4.35" stroke="#0b1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#0b1220" stroke-width="2"/></svg>
        <input id="search" placeholder="Search by name, game, ref..." />
      </div>
      <button class="filter-btn active" id="filterAll">All</button>
      <button class="filter-btn" id="filterWin">Rewards</button>
      <button class="filter-btn" id="filterBet">Bet</button>
    </div>
  </header>

  <main>
    <div class="list" id="list">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>Loading transactions...</div>
      </div>
    </div>
  </main>
</div>

<!-- Modal overlay -->
<div class="overlay" id="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <button class="close-btn" id="closeBtn" title="Close">✕</button>
      <div class="center-title">
        <div class="game-big" id="modalGame">DEWDROP</div>
        <div class="sub-title" id="modalSub">Transaction receipt</div>
      </div>
    </div>

    <div class="modal-body">
      <div class="receipt-card">
        <div class="top">
          <div class="left">
            <div class="badge" id="modalBadge">DD</div>
            <div class="player-info">
              <div class="player-name" id="modalPlayer">Player — JOHN DOE</div>
              <div class="player-date" id="modalDate">May 1, 2025 — 12:34 PM</div>
            </div>
          </div>
          <div style="text-align:right; flex-shrink: 0;">
            <div style="font-size:16px; font-weight:900" id="modalAmount">+50</div>
            <div style="font-size:12px; color:var(--muted)">Balance: ₦1,234.00</div>
          </div>
        </div>

        <div class="receipt-grid">
          <div class="field">
            <div class="label">GAME</div>
            <div class="value" id="fGame">DEWDROP</div>
          </div>
          <div class="field">
            <div class="label">PLAYER NAME</div>
            <div class="value" id="fName">JOHN DOE</div>
          </div>
          <div class="field">
            <div class="label">BET AMOUNT</div>
            <div class="value" id="fBet">₦30</div>
          </div>
          <div class="field">
            <div class="label">REWARD AMOUNT</div>
            <div class="value" id="fReward">₦50</div>
          </div>
          <div class="field">
            <div class="label">TRANSACTION TYPE</div>
            <div class="value" id="fType">PAYOUT</div>
          </div>
          <div class="field">
            <div class="label">REFERENCE</div>
            <div class="value" id="fRef">TRX-20250501-0001</div>
          </div>
        </div>

        <div class="notes">
          <strong>Notes:</strong> This is a generated receipt. Always keep your transaction reference for future queries.
        </div>
        
        <!-- Words Button -->
        <div style="margin-top: 16px;">
          <button class="btn primary" id="viewWordsBtn" style="width: 100%;">View Words & Word Bag</button>
        </div>
      </div>

      <aside class="side">
        <div class="row"><div class="k">Status</div><div class="v" id="sStatus">Successful</div></div>
        <div class="row"><div class="k">Date & Time</div><div class="v" id="sDate">—</div></div>
        <div class="row"><div class="k">Game</div><div class="v" id="sGame">DEWDROP</div></div>
        <div class="row"><div class="k">Player</div><div class="v" id="sPlayer">JOHN DOE</div></div>
        <div class="row"><div class="k">Bet Amount</div><div class="v" id="sBet">₦0</div></div>
        <div class="row"><div class="k">Reward</div><div class="v" id="sReward">₦0</div></div>
        <div class="row"><div class="k">Balance After</div><div class="v" id="sBal">₦0</div></div>
        <div class="row"><div class="k">Ref</div><div class="v" id="sRef">—</div></div>

        <div class="cta">
          <button class="btn ghost" id="printBtn">Print</button>
          <button class="btn primary" id="downloadBtn">Download</button>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- Words Modal -->
<div class="words-modal" id="wordsModal">
  <div class="words-container">
    <div class="words-header">
      <button class="words-close-btn" id="wordsCloseBtn" title="Close">✕</button>
      <div class="center-title">
        <div class="game-big">DEWDROP</div>
        <div class="sub-title">Word Bag & Words Played</div>
      </div>
    </div>
    <div class="words-body">
      <div class="words-section">
        <h3>Word Bag</h3>
        <div class="word-bag-display" id="wordBagDisplay">
          <!-- Word bag letters will be inserted here -->
        </div>
      </div>
      <div class="words-section">
        <h3>Words Played</h3>
        <div class="words-list" id="wordsPlayedList">
          <!-- Words played will be inserted here -->
        </div>
      </div>
      <div class="words-section">
        <h3>Valid Words</h3>
        <div class="words-list" id="validWordsList">
          <!-- Valid words will be inserted here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDivFTAKUznc1xryU8marfMDZG3v1eYsl8",
    authDomain: "englabet-ad1fe.firebaseapp.com",
    projectId: "englabet-ad1fe",
    storageBucket: "englabet-ad1fe.firebasestorage.app",
    messagingSenderId: "124544822433",
    appId: "1:124544822433:web:c77c980f28c99364c214e0",
    measurementId: "G-JMYYM433R7"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  let transactionData = [];
  let currentSelectedItem = null;

  const listEl = document.getElementById('list');
  const overlay = document.getElementById('overlay');
  const wordsModal = document.getElementById('wordsModal');

  // Format currency
  function formatCurrency(n){
    const nf = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return '₦' + nf.format(n);
  }

  // Format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Load transactions from Firestore
  async function loadTransactions() {
    try {
      if (!currentUser) {
        throw new Error("No user logged in");
      }

      const snapshot = await db.collection('users').doc(currentUser.uid)
        .collection('bet_history')
        .orderBy('timestamp', 'desc')
        .limit(50)
        .get();

      const transactions = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        
        // Extract the user name correctly
        let playerName = currentUser.displayName || currentUser.email || 'Unknown Player';
        
        // Extract game name correctly
        let gameName = 'Dewdrop Challenge';
        
        // Extract words played and word bag
        const wordsPlayed = data.words || [];
        const wordBag = data.wordBag || [];
        const validWords = data.validWords || [];
        
        transactions.push({
          id: doc.id,
          game: gameName,
          player: playerName,
          bet: data.betAmount || 0,
          reward: data.result >= 0 ? data.result : 0,
          amount: data.result || 0,
          date: data.date || new Date().toISOString(),
          status: data.result >= 0 ? 'WIN' : 'LOSE',
          balanceAfter: data.balance || 0,
          ref: doc.id,
          wordsPlayed: wordsPlayed,
          wordBag: wordBag,
          validWords: validWords
        });
      });

      return transactions;
    } catch (error) {
      console.error("Error loading transactions:", error);
      throw error;
    }
  }

  // Create transaction row
  function createRow(item){
    const r = document.createElement('div');
    r.className = `receipt ${item.amount >= 0 ? 'win' : 'lose'}`;
    r.dataset.id = item.id;

    // left
    const left = document.createElement('div');
    left.className = 'left';
    const badge = document.createElement('div');
    badge.className = 'game-badge';
    badge.textContent = item.game.split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();

    const meta = document.createElement('div');
    meta.className = 'meta';
    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = item.player.toUpperCase();
    const small = document.createElement('div');
    small.className = 'small';
    small.textContent = item.game + ' • ' + formatDate(item.date).split(' — ')[0];

    meta.appendChild(title);
    meta.appendChild(small);
    left.appendChild(badge);
    left.appendChild(meta);

    // middle
    const middle = document.createElement('div');
    middle.className = 'middle';
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.textContent = item.status;
    const note = document.createElement('div');
    note.className = 'note';
    note.textContent = 'Ref: ' + item.id;

    middle.appendChild(tag);
    middle.appendChild(note);

    // amount
    const amount = document.createElement('div');
    amount.className = 'amount ' + (item.amount >= 0 ? 'plus' : 'minus');
    amount.textContent = (item.amount >= 0 ? '+' : '') + formatCurrency(item.amount);

    r.appendChild(left);
    r.appendChild(middle);
    r.appendChild(amount);

    r.addEventListener('click', () => openModal(item));
    return r;
  }

  // Render transaction list
  function renderList(items){
    listEl.innerHTML = '';
    
    if (items.length === 0) {
      listEl.innerHTML = `
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
            <path d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3Z" fill="currentColor"/>
            <path d="M14 17H7V15H14V17ZM17 13H7V11H17V13ZM17 9H7V7H17V9Z" fill="currentColor"/>
          </svg>
          <div>No transactions found</div>
          <div style="font-size: 12px; margin-top: 8px;">Your transaction history will appear here</div>
        </div>
      `;
      return;
    }

    for(const it of items){
      listEl.appendChild(createRow(it));
    }
  }

  // Show loading state
  function showLoading() {
    listEl.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>Loading transactions...</div>
      </div>
    `;
  }

  // Show error state
  function showError(message) {
    listEl.innerHTML = `
      <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
        </svg>
        <div>Unable to load transactions</div>
        <div style="font-size: 12px; margin-top: 8px;">${message}</div>
        <button class="filter-btn" onclick="initializeApp()" style="margin-top: 12px;">Try Again</button>
      </div>
    `;
  }

  // Modal population & open/close
  const modalGame = document.getElementById('modalGame');
  const modalSub  = document.getElementById('modalSub');
  const modalBadge = document.getElementById('modalBadge');
  const modalPlayer = document.getElementById('modalPlayer');
  const modalDate = document.getElementById('modalDate');
  const modalAmount = document.getElementById('modalAmount');

  const fGame = document.getElementById('fGame');
  const fName = document.getElementById('fName');
  const fBet = document.getElementById('fBet');
  const fReward = document.getElementById('fReward');
  const fType = document.getElementById('fType');
  const fRef = document.getElementById('fRef');

  const sStatus = document.getElementById('sStatus');
  const sDate = document.getElementById('sDate');
  const sGame = document.getElementById('sGame');
  const sPlayer = document.getElementById('sPlayer');
  const sBet = document.getElementById('sBet');
  const sReward = document.getElementById('sReward');
  const sBal = document.getElementById('sBal');
  const sRef = document.getElementById('sRef');

  const viewWordsBtn = document.getElementById('viewWordsBtn');
  const wordBagDisplay = document.getElementById('wordBagDisplay');
  const wordsPlayedList = document.getElementById('wordsPlayedList');
  const validWordsList = document.getElementById('validWordsList');

  function openModal(item){
    currentSelectedItem = item;
    
    modalGame.textContent = item.game;
    modalSub.textContent = 'Detailed Receipt';
    modalBadge.textContent = item.game.split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
    modalPlayer.textContent = 'Player — ' + item.player.toUpperCase();
    modalDate.textContent = formatDate(item.date);
    modalAmount.textContent = (item.amount >= 0 ? '+' : '') + formatCurrency(item.amount);

    fGame.textContent = item.game;
    fName.textContent = item.player;
    fBet.textContent = formatCurrency(item.bet);
    fReward.textContent = formatCurrency(item.reward);
    fType.textContent = item.amount >= 0 ? 'PAYOUT' : 'BET';
    fRef.textContent = item.id;

    sStatus.textContent = item.status;
    sDate.textContent = formatDate(item.date);
    sGame.textContent = item.game;
    sPlayer.textContent = item.player;
    sBet.textContent = formatCurrency(item.bet);
    sReward.textContent = formatCurrency(item.reward);
    sBal.textContent = formatCurrency(item.balanceAfter);
    sRef.textContent = item.id;

    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden','false');
    document.getElementById('closeBtn').focus();
  }

  function openWordsModal() {
    if (!currentSelectedItem) return;
    
    // Clear previous content
    wordBagDisplay.innerHTML = '';
    wordsPlayedList.innerHTML = '';
    validWordsList.innerHTML = '';
    
    // Display word bag
    if (currentSelectedItem.wordBag && currentSelectedItem.wordBag.length > 0) {
      currentSelectedItem.wordBag.forEach(letter => {
        const chip = document.createElement('div');
        chip.className = 'letter-chip';
        chip.textContent = letter.toUpperCase();
        wordBagDisplay.appendChild(chip);
      });
    } else {
      wordBagDisplay.innerHTML = '<div style="color: var(--muted); font-style: italic;">No word bag data available</div>';
    }
    
    // Display words played
    if (currentSelectedItem.wordsPlayed && currentSelectedItem.wordsPlayed.length > 0) {
      currentSelectedItem.wordsPlayed.forEach(word => {
        const badge = document.createElement('div');
        const isValid = currentSelectedItem.validWords && currentSelectedItem.validWords.includes(word);
        badge.className = `word-badge ${isValid ? 'valid' : 'invalid'}`;
        badge.textContent = word.toUpperCase();
        wordsPlayedList.appendChild(badge);
      });
    } else {
      wordsPlayedList.innerHTML = '<div style="color: var(--muted); font-style: italic;">No words played data available</div>';
    }
    
    // Display valid words
    if (currentSelectedItem.validWords && currentSelectedItem.validWords.length > 0) {
      currentSelectedItem.validWords.forEach(word => {
        const badge = document.createElement('div');
        badge.className = 'word-badge valid';
        badge.textContent = word.toUpperCase();
        validWordsList.appendChild(badge);
      });
    } else {
      validWordsList.innerHTML = '<div style="color: var(--muted); font-style: italic;">No valid words data available</div>';
    }
    
    wordsModal.classList.add('open');
  }

  function closeModal(){
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden','true');
    currentSelectedItem = null;
  }

  function closeWordsModal() {
    wordsModal.classList.remove('open');
  }

  document.getElementById('closeBtn').addEventListener('click', closeModal);
  overlay.addEventListener('click', (ev) => {
    if(ev.target === overlay) closeModal();
  });

  document.getElementById('wordsCloseBtn').addEventListener('click', closeWordsModal);
  wordsModal.addEventListener('click', (ev) => {
    if(ev.target === wordsModal) closeWordsModal();
  });

  viewWordsBtn.addEventListener('click', openWordsModal);

  // Search & filters
  const searchInput = document.getElementById('search');
  const filterAll = document.getElementById('filterAll');
  const filterWin = document.getElementById('filterWin');
  const filterBet = document.getElementById('filterBet');

  let currentFilter = 'all';

  function applyFilter(query='', mode='all'){
    const q = query.trim().toLowerCase();
    let items = transactionData.filter(it => {
      if(!q) return true;
      return it.player.toLowerCase().includes(q) || 
             it.game.toLowerCase().includes(q) || 
             it.id.toLowerCase().includes(q) ||
             it.ref.toLowerCase().includes(q);
    });

    if(mode === 'win'){
      items = items.filter(it => it.amount > 0);
    } else if(mode === 'bet'){
      items = items.filter(it => it.amount < 0);
    }
    
    renderList(items);
  }

  function setActiveFilter(button, mode) {
    // Remove active class from all filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    button.classList.add('active');
    currentFilter = mode;
    applyFilter(searchInput.value, mode);
  }

  searchInput.addEventListener('input', (e) => applyFilter(e.target.value, currentFilter));
  filterAll.addEventListener('click', () => setActiveFilter(filterAll, 'all'));
  filterWin.addEventListener('click', () => setActiveFilter(filterWin, 'win'));
  filterBet.addEventListener('click', () => setActiveFilter(filterBet, 'bet'));

  // Print & Download
  document.getElementById('printBtn').addEventListener('click', () => {
    window.print();
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const lines = [
      'DEWDROP — Transaction Receipt',
      '-------------------------------',
      'Game: ' + fGame.textContent,
      'Player: ' + fName.textContent,
      'Bet Amount: ' + fBet.textContent,
      'Reward Amount: ' + fReward.textContent,
      'Type: ' + fType.textContent,
      'Reference: ' + fRef.textContent,
      'Date: ' + sDate.textContent,
      'Status: ' + sStatus.textContent,
      'Balance After: ' + sBal.textContent,
      '',
      'Thank you for using Dewdrop.'
    ];
    const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (fRef.textContent || 'receipt') + '.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && overlay.classList.contains('open')) closeModal();
    if(e.key === 'Escape' && wordsModal.classList.contains('open')) closeWordsModal();
  });

  // Make receipt elements focusable for keyboard
  function makeFocusable(){
    document.querySelectorAll('.receipt').forEach(el => {
      el.setAttribute('tabindex','0');
      el.setAttribute('role','button');
      el.style.outline = 'none';
    });
  }

  // Initialize app
  async function initializeApp() {
    showLoading();
    
    try {
      // Check authentication
      await new Promise((resolve, reject) => {
        const unsubscribe = auth.onAuthStateChanged(user => {
          unsubscribe();
          if (user) {
            currentUser = user;
            resolve(user);
          } else {
            reject(new Error("User not authenticated"));
          }
        });
      });

      // Load transactions
      transactionData = await loadTransactions();
      renderList(transactionData);
      makeFocusable();
      
    } catch (error) {
      console.error("Initialization error:", error);
      if (error.message === "User not authenticated") {
        showError("Please log in to view your transaction history");
      } else {
        showError("Failed to load transactions. Please check your connection.");
      }
    }
  }

  // Observe list changes to reassign focusable
  const obs = new MutationObserver(() => makeFocusable());
  obs.observe(listEl, { childList:true });

  // Start the app
  initializeApp();

</script>
</body>
</html>